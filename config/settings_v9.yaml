# config/settings_v9.yaml
data:
  # 우선 순위: partitioned 디렉터리 → 단일 파일
  path_primary: "data/partitioned"
  path_fallback: "data/processed/BTCUSDT_15m.parquet"
  symbol: "BTCUSDT"
  tf: "15m"
  start: null   # 예: "2025-09-01"
  end:   null   # 예: "2025-11-07"

indicators:
  ema: [21, 55]
  rsi: 14
  atr: 14
  adx: 14
  # slope 정규화 상수(봉당 % 단위). 값↑ = 보수적
  ema_slope_norm: 0.05
  ema_bias_norm: 0.010

gates:
  require_mtf: false
  use_adx_gate: true
  adx_min: 20            # 20→22로 상향 (촙 컷)
  use_trend_gate: true
  ema_slope_min: 0.03      # 0.06
  ema_slope_min_chop: 0.06 # 0.10
  use_range_gate: true
  min_range_atr: 0.50    # 0.60
  range_on_bars: 3
  cooloff_bars: 1
  align_price_ema: true
  use_dev_guard: true
  max_dev_atr: 0.80    # 0.60
  
  # 신규 게이트
  use_adx_slope_gate: true
  adx_slope_k: 3
  min_adx_slope: 0.5     # 최근 3봉 누적 +0.5 이상

  use_wick_gate: true
  max_wick_ratio: 5.0

  use_rsi_align_gate: true

  use_session_gate: false   # 필요 시 true
  allow_sessions: ["asia","eu","us"]

  use_ema_bias_gate: true  # ✅ 신규 (align_price_ema 대체)
  align_price_ema: false   # ✅ 비활성화 (중복)
  
scoring:
  weights:
    trend: 0.25
    momentum: 0.25
    volatility: 0.15
    participation: 0.20  # ✅ 신규
    location: 0.15       # ✅ 신규
  vol_mode: "q90"   # "q90" | "iqr" (iqr로 바꾸면 과열 판정 더 보수적)
  bias_trend_cand: 0.02
  bias_trend_enter: 0.04 

# ===== EWQ (Exponentially Weighted Quantile) =====
ewq:
  initial_threshold: 70.0     # 초기 임계값 (스케일: [-100, 100])
  theta: 0.7                  # 목표 분위 (0.7 = 상위 30%)
  alpha: 0.05                 # 학습률
  daily_cap: 0.03            # 일일 최대 변동 (3%)
  tf_per_day: 96             # 하루 봉 수 (15m)

# ===== 임계값 모드 =====
use_ewq: false  # true면 EWQ 동적 임계값, false면 분위 기반

thresholds:
  cand_score_min: 0.02
  enter_score_min: 0.08

risk:
  R: 0.005
  max_leverage: 7
  lev_map:
    - { min: 0.60, max: 0.65, lev: 2 }
    - { min: 0.65, max: 0.75, lev: 4 }
    - { min: 0.75, max: 0.80, lev: 6 }
    - { min: 0.80, max: 1.00, lev: 7 }
  atr_tp: [1.2, 1.3, 1.5]
  atr_sl: 1.0
  trail_k: 0.5
  max_hold_min: 75           # 12h → 3h로 완화(초기 MDD 방지)

  # ===== MDD Breaker (v9.4 신규) =====
  enable_mdd_breaker: false   # 운영 시 true 권장
  mdd_breaker: 0.05          # 5% MDD에서 모든 거래 중단

output:
  trades_csv: "logs/trades.csv"
  dbg_json:   "logs/last_debug.json"

debug:
  auto_thresholds:
    cand_pct: 0.76            # cand = 상위 22%
    enter_pct: 0.88           # enter = 상위 12%
  no_gate: false
  force_cand_from_score: false  # ★ 게이트 우회 금지
  force_pct: 0.75
  log_breakdown: true

session:
  tz_offset_hours: 0

validation:
  cpcv_splits: 5          # 전체 분할 수
  cpcv_test_groups: 2     # 각 fold의 test 그룹 수 (C(5,2)=10 folds)
  embargo_pct: 0.01       # Embargo 1%
  bootstrap_samples: 1000 # Bootstrap 샘플 수 (별도)